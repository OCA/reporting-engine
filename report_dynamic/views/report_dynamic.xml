<?xml version="1.0" ?>
<odoo>
    <record id="report_dynamic_form" model="ir.ui.view">
        <field name="name">report.dynamic.form</field>
        <field name="model">report.dynamic</field>
        <field name="arch" type="xml">
            <form string="Report">
                <sheet>
                    <!-- ribbon to show the record as locked -->
                    <widget
                        name="web_ribbon"
                        title="Locked"
                        bg_color="bg-danger"
                        attrs="{'invisible': [('lock_date', '=', False)]}"
                    />
                    <div class="oe_button_box" name="button_box">
                        <!-- button to preview a HTML version of a template -->
                        <button
                            name="action_preview_content"
                            string="Preview"
                            class="oe_stat_button"
                            icon="fa-eye"
                            type="object"
                            attrs="{'invisible':[('is_template', '=', False)]}"
                        />
                        <!-- button to quick view a HTML version of the report -->
                        <button
                            name="action_quick_view_content"
                            string="Quick view"
                            class="oe_stat_button"
                            icon="fa-eye"
                            type="object"
                            attrs="{'invisible':['|', ('is_template', '=', True), ('resource_ref', '=', False)]}"
                        />
                        <!-- action to remove or create a contextual 'More..' server action on the model -->
                        <field name="window_action_exists" invisible="1" />
                        <button
                            name="create_action"
                            type="object"
                            string="Add Sidebar Button"
                            class="oe_inline oe_stat_button"
                            attrs="{'invisible':['|',('window_action_exists','=',True),('is_template', '=', False)]}"
                            icon="fa-plus"
                            help="Display a button in the sidebar of related documents to open a composition wizard"
                        />
                        <button
                            name="unlink_action"
                            type="object"
                            string="Remove Sidebar Button"
                            class="oe_stat_button"
                            icon="fa-minus"
                            attrs="{'invisible':['|',('window_action_exists','=',False),('is_template', '=', False)]}"
                            help="Remove the contextual action to use this template on related documents"
                            widget="statinfo"
                        />
                        <!-- smartbutton for linked reports -->
                        <button
                            type="object"
                            name="action_view_reports"
                            class="oe_stat_button"
                            icon="fa-file-text-o"
                            attrs="{'invisible': [('is_template', '=', False),('report_count', '=', 0)]}"
                        >
                            <field
                                name="report_count"
                                widget="statinfo"
                                string="Reports"
                            />
                        </button>
                        <!-- action to navigate to the dynamic sections of a report -->
                        <field name="section_ids" invisible="1" />
                        <button
                            type="object"
                            name="action_view_sections"
                            class="oe_stat_button"
                            icon="fa-file-text-o"
                            attrs="{'invisible': [('section_count', '=', 0)]}"
                            groups="base.group_user"
                        >
                            <field
                                name="section_count"
                                widget="statinfo"
                                string="Sections"
                            />
                        </button>
                        <!-- action to duplicate this report as a new template -->
                        <button
                            name="action_duplicate_as_template"
                            type="object"
                            string="Use as new template"
                            class="oe_stat_button"
                            attrs="{'invisible':[('is_template', '=', True)]}"
                            icon="fa-copy"
                            help="Use this modified report as a base to create a new template"
                            confirm="Are you sure you want to create a new template from this?"
                            groups="report_dynamic.group_report_dynamic_template_editors"
                        />
                        <!-- boolean button to archive or unarchive this record -->
                        <button
                            name="toggle_active"
                            type="object"
                            class="oe_stat_button"
                            icon="fa-archive"
                        >
                            <field
                                name="active"
                                widget="boolean_button"
                                options="{'terminology': {
                            'string_true': 'Active',
                            'hover_true': 'Archive',
                            'string_false': 'Archived',
                            'hover_false': 'Unarchive'
                        }}"
                            />
                        </button>
                        <!-- button to lock the report -->
                        <button
                            name="action_wizard_lock_report"
                            string="Lock"
                            type="object"
                            class="oe_stat_button"
                            icon="fa-lock"
                            attrs="{'invisible': ['|', ('is_template', '=', True), ('lock_date', '!=', False)]}"
                            context="{'default_report_id': active_id}"
                            help="Lock this report for editing"
                        />
                    </div>
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only" string="Report name" />
                        <h1>
                            <field name="name" />
                        </h1>
                    </div>
                    <group name="main">
                        <group name="left">
                            <field
                                name="template_id"
                                attrs="{'readonly': [('lock_date', '!=', False)], 'invisible': [('is_template', '=', True)], 'required': [('is_template', '=', False)]}"
                            />
                            <field
                                name="model_id"
                                attrs="{'readonly':[('is_template', '=', False)]}"
                            />
                            <field
                                name="resource_ref"
                                options="{'hide_model': True, 'no_create': True, 'no_edit': True, 'no_open': True}"
                                attrs="{'invisible': [('is_template', '=', True)], 'readonly':[('lock_date', '!=', False)]}"
                            />
                            <field name="model_model" invisible="1" />
                            <field
                                name="wrapper_report_id"
                                attrs="{'invisible': [('is_template', '=', False)]}"
                            />
                            <field name="is_template" invisible="1" />
                            <field
                                name="lock_date"
                                attrs="{'invisible': ['|', ('is_template', '=', True), ('lock_date', '=', False)]}"
                                force_save='True'
                            />
                        </group>
                        <group name="right">
                            <field
                                name="condition_domain_global"
                                widget="domain"
                                options="{'model': 'model_model', 'in_dialog': True}"
                                attrs="{'invisible': [('is_template', '=', False)]}"
                                help="When you have multiple templates for one model (eg. a contract for senior employees and another for juniors), this domain is used to determine the domain condition that decides for which records to choose this template (eg. [('employee_id.skill_level', '=', 'junior')])"
                            />
                        </group>
                    </group>
                    <notebook>
                        <page name="dynamic_content" string="Dynamic content">
                            <field
                                name="section_ids"
                                attrs="{'readonly':[('lock_date', '!=', False)]}"
                            >
                                <tree decoration-bf="is_paragraph">
                                    <field name="sequence" widget="handle" />
                                    <field name="name" />
                                    <field name="condition_python" />
                                    <field name="condition_domain" />
                                    <field name="is_paragraph" invisible="1" />
                                </tree>
                            </field>
                        </page>
                        <page name="help" string="Help">
                            <field name="documentation" />
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="report_dynamic_tree" model="ir.ui.view">
        <field name="name">report.dynamic.tree</field>
        <field name="model">report.dynamic</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name" readonly="True" />
                <field
                    name="template_id"
                    readonly="True"
                    invisible="bool(context.get('is_template'))"
                    string="Template"
                />
                <field name="model_id" readonly="True" />
                <field
                    name="resource_ref"
                    readonly="True"
                    invisible="bool(context.get('is_template'))"
                    string="Target record"
                />
            </tree>
        </field>
    </record>

    <!-- Search view -->
    <record id="report_dynamic_search" model="ir.ui.view">
        <field name="name">report.dynamic.search</field>
        <field name="model">report.dynamic</field>
        <field name="arch" type="xml">
            <search>
                <field name="name" />
                <field name="model_id" />
                <!-- TODO: add string here -->
                <field name="group_by_record_name" />
                <filter
                    string="Archived"
                    name="active"
                    domain="[('active', '=',False)]"
                />
                <group expand="0" string="Group By">
                    <filter
                        string="Model"
                        name="Model"
                        context="{'group_by': 'model_id'}"
                    />
                    <filter
                        string="Record"
                        name="Record"
                        context="{'group_by': 'group_by_record_name'}"
                    />
                </group>
            </search>
        </field>
    </record>

    <!-- main menu -->
    <menuitem name="Dynamic Reports" id="report_dynamic_menu_root" sequence="300" />
    <!-- action and menu for templates-->
    <record id="report_dynamic_template_action" model="ir.actions.act_window">
        <field name="name">Templates</field>
        <field name="res_model">report.dynamic</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('is_template', '=', True)]</field>
        <field name="context">{'default_is_template': True, 'is_template':True}</field>
    </record>
    <menuitem
        name="Templates"
        id="report_dynamic_template_menu"
        parent="report_dynamic_menu_root"
        sequence="100"
        action="report_dynamic_template_action"
        groups="report_dynamic.group_report_dynamic_template_editors"
    />
    <!-- action and menu for reports-->
    <record id="report_dynamic_action" model="ir.actions.act_window">
        <field name="name">Reports</field>
        <field name="res_model">report.dynamic</field>
        <field name="domain">[('is_template', '=', False)]</field>
        <field name="view_mode">tree,form</field>
    </record>
    <menuitem
        name="Reports"
        id="report_dynamic_report_menu"
        parent="report_dynamic_menu_root"
        sequence="200"
        action="report_dynamic_action"
    />
</odoo>
